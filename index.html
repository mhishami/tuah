<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Tuah by mhishami</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Tuah</h1>
      <h2 class="project-tagline">A Simple Cowboy Frontend, inspired by BeepBeep</h2>
      <a href="https://github.com/mhishami/tuah" class="btn">View on GitHub</a>
      <a href="https://github.com/mhishami/tuah/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/mhishami/tuah/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <p><img src="https://raw.githubusercontent.com/mhishami/tuah/master/example/foo/priv/static/img/tuah-small.png" alt="logo"></p>

<blockquote>
<h1>
<a id="tuah" class="anchor" href="#tuah" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tuah</h1>

<p>Tuah is a simple, HTTP framework, inspired by BeepBeep with Cowboy as the underlying mechanism.</p>

<p>Easy to extend, comes with session management and continous code compilations to make it a very productive framework to begin with.</p>

<p>Built on the strength of Cowboy and MongoDB, development time is greatly reduced.</p>
</blockquote>

<h2>
<a id="quick-start" class="anchor" href="#quick-start" aria-hidden="true"><span class="octicon octicon-link"></span></a>Quick Start</h2>

<ol>
<li>
<p>Create A New Project</p>

<p>Creating a new project is made simpler via the addition of <code>new_app.sh</code> script.</p>

<div class="highlight highlight-source-shell"><pre>hisham@skrall:tuah$ ./new_app.sh foo
Creating new app: foo
Creating directory...
Creating template files...
Creating bootstrap files...
Finishing up...
Done. Your app is created <span class="pl-k">in</span> ../foo.
+----------------------+
<span class="pl-k">|</span>     Happy coding<span class="pl-k">!</span>    <span class="pl-k">|</span>
+----------------------+
hisham@skrall:tuah$ 
</pre></div>
</li>
<li>
<p>The project structure looks like</p>

<div class="highlight highlight-source-shell"><pre>foo
├── Makefile
├── erlang.mk
├── include
│   └── foo.hrl
├── priv
│   └── static
│       ├── assets/
│       ├── css/
│       ├── dist/  
│       └── img
│           ├── tuah-small.png
│           └── tuah.png
├── rel
│   ├── sys.config
│   └── vm.args
├── relx
├── relx.config
├── run.sh
├── src
│   ├── auth_controller.erl
│   ├── baz.app.src
│   ├── baz_app.erl
│   ├── baz_sup.erl
│   ├── home_controller.erl
│   └── secret_controller.erl
└── templates
    ├── error.dtl
    ├── home.dtl
    ├── login.dtl
    ├── public.dtl
    └── register.dtl
</pre></div>
</li>
<li><p>Start the mongodb server, as the sample application does live registration and all.</p></li>
<li>
<p>Run The App</p>

<blockquote>
<h1>
<a id="the-app" class="anchor" href="#the-app" aria-hidden="true"><span class="octicon octicon-link"></span></a>The App</h1>

<p>This simple app does user registration, login and logout.
Extend this further to your likings.</p>
</blockquote>

<div class="highlight highlight-source-shell"><pre>$ make
$ ./run.sh console
</pre></div>

<p>View the app at http://localhost:8080<br>
That's it!</p>
</li>
<li><p>Extend the app the way you like it by adding more templates, controllers to make a full blown app.</p></li>
<li><p>Feel free to fork this. Cheers!</p></li>
</ol>

<h2>
<a id="mongo-backend" class="anchor" href="#mongo-backend" aria-hidden="true"><span class="octicon octicon-link"></span></a>Mongo Backend</h2>

<ol>
<li><p>Tuah framework comes with mongo client integration. Almost <em>all</em> the APIs are supported. Feel free to browse the source code.</p></li>
<li><p>Advanced examples such as regex search, complex find and match are supported. Details query and projection operators can be found at <a href="MongoDB%20Reference">https://docs.mongodb.org/manual/reference/operator/</a></p></li>
<li>
<p>Different notations for Selector/Projector, use which one that you like. I preferred the second notation as it is easier to read and comprehend.</p>

<div class="highlight highlight-source-erlang"><pre><span class="pl-en">mongo_worker</span>:<span class="pl-en">find</span>(&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>posts<span class="pl-pds">"</span></span>&gt;&gt;, {&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>tag<span class="pl-pds">"</span></span>&gt;&gt;, &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>general<span class="pl-pds">"</span></span>&gt;&gt;, 
                                &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>cat<span class="pl-pds">"</span></span>&gt;&gt;, &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>News<span class="pl-pds">"</span></span>&gt;&gt;}, 
  [{<span class="pl-c1">batchsize</span>, <span class="pl-c1">10</span>}, {<span class="pl-c1">skip</span>, <span class="pl-c1">20</span>}, 
  {<span class="pl-c1">projector</span>, {&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>created_at<span class="pl-pds">"</span></span>&gt;&gt;, <span class="pl-c1">1</span>, &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>grpid<span class="pl-pds">"</span></span>&gt;&gt;, <span class="pl-c1">1</span>}}]).</pre></div>

<div class="highlight highlight-source-erlang"><pre><span class="pl-en">mongo_worker</span>:<span class="pl-en">find</span>(&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>posts<span class="pl-pds">"</span></span>&gt;&gt;, #{&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>tag<span class="pl-pds">"</span></span>&gt;&gt; <span class="pl-k">=&gt;</span> &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>general<span class="pl-pds">"</span></span>&gt;&gt;, 
                                 &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>cat<span class="pl-pds">"</span></span>&gt;&gt; <span class="pl-k">=&gt;</span> &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>News<span class="pl-pds">"</span></span>&gt;&gt;}, 
  [{<span class="pl-c1">batchsize</span>, <span class="pl-c1">10</span>}, {<span class="pl-c1">skip</span>, <span class="pl-c1">20</span>}, 
  {<span class="pl-c1">projector</span>, #{&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>created_at<span class="pl-pds">"</span></span>&gt;&gt; <span class="pl-k">=&gt;</span> <span class="pl-c1">1</span>, &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>grpid<span class="pl-pds">"</span></span>&gt;&gt; <span class="pl-k">=&gt;</span> <span class="pl-c1">1</span>}}]).</pre></div>
</li>
<li>
<p>Regular expressions are also there.</p>

<div class="highlight highlight-source-erlang"><pre><span class="pl-en">mongo_worker</span>:<span class="pl-en">find</span>(&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>posts<span class="pl-pds">"</span></span>&gt;&gt;, 
  {&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>title<span class="pl-pds">"</span></span>&gt;&gt;, #{&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>$regex<span class="pl-pds">"</span></span>&gt;&gt;  <span class="pl-k">=&gt;</span> &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>some*<span class="pl-pds">"</span></span>&gt;&gt;, 
                  &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>$options<span class="pl-pds">"</span></span>&gt;&gt; <span class="pl-k">=&gt;</span> &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>i<span class="pl-pds">"</span></span>&gt;&gt;}}, 
  [{<span class="pl-c1">projector</span>, #{&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>grpid<span class="pl-pds">"</span></span>&gt;&gt; <span class="pl-k">=&gt;</span> <span class="pl-c1">1</span>, 
                 &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>title<span class="pl-pds">"</span></span>&gt;&gt; <span class="pl-k">=&gt;</span> <span class="pl-c1">1</span>, 
                 &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>author.fullname<span class="pl-pds">"</span></span>&gt;&gt; <span class="pl-k">=&gt;</span> <span class="pl-c1">1</span>}}]).</pre></div>
</li>
</ol>

<h2>
<a id="routing" class="anchor" href="#routing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Routing</h2>

<ol>
<li><p>Routing is made simple in tuah, where the URL is broken up into multiple items, to be handled by the request handlers.</p></li>
<li>
<p>Below is the breakdown of the request URL, and the components it is broken up into:</p>

<ul>
<li>
<p><code>/post/message/20</code></p>

<ul>
<li>
<strong>Controller</strong>: <code>post_controller.erl</code>
</li>
<li>
<strong>Action</strong>: <code>&lt;&lt;"message"&gt;&gt;</code>
</li>
<li>
<strong>Args</strong>: <code>[ 20 ]</code>
</li>
</ul>
</li>
<li>
<p><code>/user/view/details/100</code></p>

<ul>
<li>
<strong>Controller</strong>: <code>user_controller.erl</code>
</li>
<li>
<strong>Action</strong>: <code>&lt;&lt;"view"&gt;&gt;</code>
</li>
<li>
<strong>Args</strong>: <code>[&lt;&lt;"details"&gt;&gt;, 100]</code>
</li>
</ul>
</li>
<li>
<p><code>/view/message/20?float=false&amp;data=none</code></p>

<ul>
<li>
<strong>Controller</strong>: <code>view_controller.erl</code>
</li>
<li>
<strong>Action</strong>: <code>&lt;&lt;"message"&gt;&gt;</code>
</li>
<li>
<strong>Args</strong>: <code>[ 20 ]</code>
</li>
<li>
<strong>Params</strong>: <code>#{qs_vals =&gt; [{&lt;&lt;"float"&gt;&gt;, &lt;&lt;"false"&gt;&gt;},
{&lt;&lt;"data"&gt;&gt;, &lt;&lt;"none"&gt;&gt;}],...}</code>
</li>
</ul>
</li>
</ul>
</li>
</ol>

<h2>
<a id="controllers" class="anchor" href="#controllers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Controllers</h2>

<ol>
<li><p>All controllers can be defined by using the <code>tuah_controller</code> behavior.</p></li>
<li>
<p>All handlers are in the form:</p>

<div class="highlight highlight-source-erlang"><pre><span class="pl-en">handle_request</span>(<span class="pl-smi">Method</span>, <span class="pl-smi">Action</span>, <span class="pl-smi">Args</span>, <span class="pl-smi">Params</span>, <span class="pl-smi">Req</span>)</pre></div>
</li>
<li>
<p>Request handler parameters:</p>

<ul>
<li><p><code>Method</code> - can be HTTP Method, capitalized (e.g. GET, POST, PUT, DELETE etc.)</p></li>
<li>
<p><code>Action</code> - the second parameters in the URL chosen, e.g.</p>

<ul>
<li>
<code>/user/delete</code> : Action = <code>delete</code>
</li>
<li>
<code>/post/view</code> : Action = <code>view</code>
</li>
</ul>
</li>
<li>
<p><code>Args</code> - the list of arguments of the URL</p>

<ul>
<li>
<code>/user/delete/20/</code> : Args = <code>[20]</code>
</li>
<li>
<code>/post/view/977/simple</code> : Args = <code>[ 997, &lt;&lt;"simple"&gt;&gt;]</code>
</li>
</ul>
</li>
<li>
<p><code>Params</code> - the request parameters</p>

<ul>
<li>
<code>qs_vals</code> : contains the <code>GET</code> query string variables</li>
<li>
<code>qs_body</code> : contains the <code>POST</code> query string variables</li>
<li>
<code>files</code> : contains the file uploads data</li>
<li>
<code>auth</code> : contains the authentication context</li>
<li>
<code>sid</code> : contains the session id</li>
</ul>
</li>
<li><p><code>Req</code> - the Cowboy Req parameters. It is hardly used, but just in case you want to play around with the Cowboy internals.</p></li>
</ul>
</li>
</ol>

<h2>
<a id="session-context" class="anchor" href="#session-context" aria-hidden="true"><span class="octicon octicon-link"></span></a>Session Context</h2>

<ol>
<li>
<p>Session context is carried in the <code>Params</code> in each request:</p>

<ul>
<li>
<code>sid</code> - The session id </li>
<li>
<code>auth</code> - The authentication context</li>
</ul>
</li>
<li><p>Authentication context is to be used sparingly. <strong>DO NOT</strong> carry sensitive information in the <code>auth</code> context. Only username/email address is suffice.</p></li>
</ol>

<h2>
<a id="authentication" class="anchor" href="#authentication" aria-hidden="true"><span class="octicon octicon-link"></span></a>Authentication</h2>

<ol>
<li><p>Authentication is done using the session context <code>auth</code> and <code>sid</code> in the <code>Params</code> of request handler.</p></li>
<li>
<p>Typical authentication procedures are:</p>

<div class="highlight highlight-source-erlang"><pre><span class="pl-en">handle_request</span>(&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>POST<span class="pl-pds">"</span></span>&gt;&gt;, &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>login<span class="pl-pds">"</span></span>&gt;&gt; <span class="pl-k">=</span> <span class="pl-smi">Action</span>, <span class="pl-smi">_Args</span>, <span class="pl-smi">Params</span>, <span class="pl-smi">_Req</span>) <span class="pl-k">-&gt;</span>    
    <span class="pl-smi">PostVals</span> <span class="pl-k">=</span> <span class="pl-en">maps</span>:<span class="pl-en">get</span>(&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>qs_body<span class="pl-pds">"</span></span>&gt;&gt;, <span class="pl-smi">Params</span>),
    <span class="pl-smi">Username</span> <span class="pl-k">=</span> <span class="pl-en">proplists</span>:<span class="pl-en">get_value</span>(&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>username<span class="pl-pds">"</span></span>&gt;&gt;, <span class="pl-smi">PostVals</span>),
    <span class="pl-smi">Password</span> <span class="pl-k">=</span> <span class="pl-en">proplists</span>:<span class="pl-en">get_value</span>(&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>password<span class="pl-pds">"</span></span>&gt;&gt;, <span class="pl-smi">PostVals</span>),

    <span class="pl-k">case</span> <span class="pl-smi">Username</span> <span class="pl-k">=:=</span> &lt;&lt;&gt;&gt; <span class="pl-k">orelse</span> <span class="pl-smi">Password</span> <span class="pl-k">=:=</span> &lt;&lt;&gt;&gt; <span class="pl-k">of</span>
        <span class="pl-c1">true</span> -&gt;
            {<span class="pl-c1">render</span>, <span class="pl-smi">Action</span>, [{<span class="pl-c1">error</span>, &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>All fields are required.<span class="pl-pds">"</span></span>&gt;&gt;}]};
        <span class="pl-v">_</span> -&gt;
            <span class="pl-k">case</span> <span class="pl-en">mongo_worker</span>:<span class="pl-en">find</span>(<span class="pl-k">?</span><span class="pl-en">DB_USERS</span>, #{&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>username<span class="pl-pds">"</span></span>&gt;&gt; <span class="pl-k">=&gt;</span> <span class="pl-smi">Username</span>}) <span class="pl-k">of</span>
                {<span class="pl-c1">ok</span>, []} -&gt;
                    {<span class="pl-c1">render</span>, <span class="pl-smi">Action</span>, [{<span class="pl-c1">error</span>, &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>Invalid username, or password<span class="pl-pds">"</span></span>&gt;&gt;}]};
                {<span class="pl-c1">ok</span>, [<span class="pl-smi">User</span>]} -&gt;
                    <span class="pl-k">?</span><span class="pl-en">DEBUG</span>(<span class="pl-s"><span class="pl-pds">"</span>User= <span class="pl-c1">~p~n</span><span class="pl-pds">"</span></span>, [<span class="pl-smi">User</span>]),
                    <span class="pl-smi">HashPass</span> <span class="pl-k">=</span> <span class="pl-en">web_util</span>:<span class="pl-en">hash_password</span>(<span class="pl-smi">Password</span>),
                    <span class="pl-smi">Pass</span> <span class="pl-k">=</span> <span class="pl-en">maps</span>:<span class="pl-en">get</span>(&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>password<span class="pl-pds">"</span></span>&gt;&gt;, <span class="pl-smi">User</span>),
                    <span class="pl-k">case</span> <span class="pl-smi">Pass</span> <span class="pl-k">=/=</span> <span class="pl-smi">HashPass</span> <span class="pl-k">of</span>
                        <span class="pl-c1">true</span> -&gt;
                            {<span class="pl-c1">render</span>, <span class="pl-smi">Action</span>, [{<span class="pl-c1">error</span>, &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>Invalid username, or password<span class="pl-pds">"</span></span>&gt;&gt;}]};
                        <span class="pl-v">_</span> -&gt;
                            <span class="pl-smi">Sid</span> <span class="pl-k">=</span> <span class="pl-en">maps</span>:<span class="pl-en">get</span>(&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>sid<span class="pl-pds">"</span></span>&gt;&gt;, <span class="pl-smi">Params</span>),
                            <span class="pl-en">session_worker</span>:<span class="pl-en">set_cookies</span>(<span class="pl-smi">Sid</span>, <span class="pl-smi">Username</span>),

                            <span class="pl-c">%% redirect, assuming "secret" is defined.</span>
                            {<span class="pl-c1">redirect</span>, &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>/secret<span class="pl-pds">"</span></span>&gt;&gt;, {<span class="pl-c1">cookie</span>, &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>auth<span class="pl-pds">"</span></span>&gt;&gt;, <span class="pl-smi">Username</span>}}
                    <span class="pl-k">end</span>
            <span class="pl-k">end</span>
    <span class="pl-k">end</span>;</pre></div>
</li>
<li>
<p>Logging out can be done by resetting the data in the session</p>

<div class="highlight highlight-source-erlang"><pre><span class="pl-en">handle_request</span>(&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>GET<span class="pl-pds">"</span></span>&gt;&gt;, &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>logout<span class="pl-pds">"</span></span>&gt;&gt;, <span class="pl-smi">_Args</span>, <span class="pl-smi">Params</span>, <span class="pl-smi">_Req</span>) <span class="pl-k">-&gt;</span>
      <span class="pl-en">session_worker</span>:<span class="pl-en">del_cookies</span>(<span class="pl-en">maps</span>:<span class="pl-en">get</span>(&lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>sid<span class="pl-pds">"</span></span>&gt;&gt;, <span class="pl-smi">Params</span>)),
      {<span class="pl-c1">redirect</span>, &lt;&lt;<span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>&gt;&gt;};</pre></div>
</li>
</ol>

<h2>
<a id="templates" class="anchor" href="#templates" aria-hidden="true"><span class="octicon octicon-link"></span></a>Templates</h2>

<ol>
<li><p>Templates are defined using <code>erlydtl</code>, which is a fork of Django Templates.</p></li>
<li><p>In each project, you should have a custom <code>error</code> template so that all errors can be shown nicely, and react accordingly.</p></li>
</ol>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/mhishami/tuah">Tuah</a> is maintained by <a href="https://github.com/mhishami">mhishami</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
